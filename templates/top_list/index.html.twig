{% extends 'base.html.twig' %}

{% block title %}Top List{% endblock %}

{% block javascripts %}
    
    <script>
        async function loadToplist(country = '') {
        try {
            // API Platform filtering by countryCode
            const response = await fetch(`http://localhost:8000/api/toplist`, {
            headers: {
                'Content-Type': 'application/json',
                // Optional: if Cloudflare header is available locally
                'CF-IPCountry': country
            }
            });

            const bonusArray = ["200% jusqu'à 500€", "100% jusqu'à 500€", "Jusqu'à 100€", "Jusqu'à 500€"];
            const moreBonusArray = ["+500 Tours Gratuits", "+20 Tours Gratuits", "+225 Tours Gratuits", "+365 Tours Gratuits"];

            const entries = await response.json();
            const listContainer = document.getElementById('brand-list');

            listContainer.innerHTML = ''; // clear previous content

            entries.forEach((brand, index) => {
            const card = document.createElement('div');
            card.className = 'row brand-card';
            let rating = '';
            let pos = index + 1;
            let ind = Math.floor(Math.random() * bonusArray.length);
            let bonus = bonusArray[ind];
            let moreBonus = moreBonusArray[ind];

            for (let i = 0; i < brand.rating; i++) {
                rating = rating + '<i class="fas fa-star"></i>';
            }

            card.innerHTML = `
                <div class="col-md-auto align-self-center">
                    <span class="position">${pos}</span>
                </div>
                <div class="col">
                    <div class="row">
                        <div class="col-md-3 align-self-center">
                            <a href="#" class="">
                                <img src="${brand.brand_image || ''}" alt="${brand.brand_name}" class="img-fluid rounded-start align-middle">
                                <strong>${brand.brand_name}</strong>
                            </a>
                        </div>
                        <div class="col-md-1 align-self-center">
                            <img src="{{ asset ('images/casino-token.png')}}" alt="${brand.brand_name}" class="img-fluid rounded-start align-middle">
                        </div>
                        <div class="col-md-3">
                            <span class="bonus">${bonus}</span><br>
                            <span class="more-bonus">${moreBonus}</span>
                        </div>
                        <div class="col-md-2 align-self-center">
                            <p>${rating}</p>
                        </div>
                        <div class="col-md-1 align-self-center">
                            <img src="{{ asset ('images/18-plus.png')}}" alt="${brand.brand_name}" class="img-fluid rounded-start align-middle">
                        </div>
                        <div class="col-md-2 align-self-center">
                            <button type="button" class="btn btn-success"><strong>Obtenir le bonus</strong></button>
                            <p class="card-text"><a href="#" class=""><strong>Visiter le site</strong></a></p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 description">
                            Lorem ipsum dolor sit amet, consectetur adipiscing elit. Integer posuere erat a ante. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam.
                        </div>
                    </div>
                </div>
            `;
            listContainer.appendChild(card);
            });

        } catch (err) {
            console.error('Failed to load brand top list', err);
        }
        }

        // Get the country code using a 3-party geolocation service or set a default value
        const userCountryCode = 'CM'; // Example for testing
        loadToplist(userCountryCode);
    </script>
{% endblock %}